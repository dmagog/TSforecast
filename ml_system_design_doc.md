# ML System Design Document

## Проект: **TS Forecast — система прогноза кассовых разрывов по филиалам сети металлопроката**

---

## 1. Бизнес-контекст и цели

### 1.1. Бизнес-контекст

Компания — производственно-торговый холдинг с сетью **100+ филиалов** по
России, специализирующийся на поставках металлопроката.

Особенности операционной модели:

- **Отгрузки и оплаты не синхронны** — временной разрыв может составлять **2–3 месяца** в обе стороны.
- Филиалы различаются по:
  - объёмам и частоте операций,
  - глубине и плотности исторических данных,
  - наличию простоев или периодов низкой активности.
- Сейчас прогноз на месяц делает **каждый филиальный менеджер вручную** →
  высокие трудозатраты и ошибки → **кассовые разрывы**.

### 1.2. Основная бизнес-цель

**Снизить вероятность и глубину кассовых разрывов** за счёт автоматизации
прогноза **отгрузок** и **оплат** по каждому филиалу.

### 1.3. ML-задачи

1. Прогноз помесячных **отгрузок** по филиалу.
2. Прогноз помесячных **оплат** по филиалу.
3. Расчет прогнозируемого **кассового разрыва**.
4. Сегментация филиалов на группы **A / B / C** по качеству прогноза.
5. Визуализация доверительных интервалов.
6. Сравнение:
   - модельного прогноза,
   - ручного прогноза менеджеров,
   - бейзлайна.

### 1.4. Стейкхолдеры

- **Генеральный директор**
- **Финансовый директор** (основной пользователь)
- **Казначейство / финансовый отдел**
- **Филиальные менеджеры**
- **ML/DS команда**
- **DevOps / системные администраторы**

---

## 2. Пользовательские сценарии

### 2.1. Финансовый директор

1. Открывает дашборд.
2. Видит прогнозы отгрузок/оплат по филиалам.
3. Видит доверительные интервалы и классы A/B/C.
4. Анализирует потенциальные кассовые разрывы.
5. Принимает решения по финансированию.

### 2.2. Казначей

- Сравнивает прогнозы модели, бейзлайна и ручных вводов.
- Анализирует проблемные филиалы.
- Экспортирует данные для отчётности.

### 2.3. ML/DS инженер

- Следит за работой Airflow-пайплайнов.
- Анализирует качество моделей (MLflow).
- Следит за дрейфами данных и количеством C-филиалов.

---

## 3. Требования

### 3.1. Функциональные требования

- Обновление прогнозов — **раз в месяц**.
- Прогнозы:
  - `forecast_shipments`
  - `forecast_payments`
  - доверительные интервалы
- Прогноз на **1 месяц обязателен**, на **2–3 месяца** — дополнительный.
- Деление филиалов на **A/B/C**.
- Указание **причин отбраковки**.
- REST API + простой веб-интерфейс.
- Хранение данных и моделей в on-prem контуре.

### 3.2. Нефункциональные требования

- Полный пайплайн ≤ **4 часа**.
- Доступность API ≥ **99%**.
- Стек:
  - **Python, Airflow, Postgres, MLflow, FastAPI**
- Данные конфиденциальны, работа внутри периметра.

---

## 4. Метрики успеха

### 4.1. Бизнес-метрики

- Снижение частоты кассовых разрывов.
- Снижение нагрузки на филиальные команды.
- Повышение точности прогнозов относительно ручного прогноза.

### 4.2. ML-метрики

- **MAPE / sMAPE** — по филиалам.
- **MAE** — для устойчивости.
- **WAPE** — на уровне сети.
- **Coverage (80%/95%)** — доверительные интервалы.
- Выигрыш относительно:
  - бейзлайна,
  - ручного прогноза.

---

## 5. Данные

### 5.1. Источники

- Помесячные выгрузки:
  - транзакции отгрузок и оплат,
  - дебиторка на начало/конец периода,
  - справочник филиалов,
  - справочник контрагентов.
- В будущем — прямой доступ к ERP/DWH.

### 5.2. Особенности данных

- Глубина истории: **6–48 месяцев**.
- Разреженность.
- Периодические простои.
- Аномальные всплески.
- Выраженная сезонность.

### 5.3. Препроцессинг

- Агрегация “филиал × месяц”.
- Лаги (1–12), MA/rolling признаки.
- Календарные признаки.
- Флаги активности.
- Обработка пропусков.
- Аномалидетектор.

---

## 6. Классификация филиалов (A/B/C)

### 6.1. Класс A — хорошие

- ≥ **24 мес** истории.
- ≥ **70%** месяцев с активностью.
- Нет длительных (> 2–3 мес) простоев.
- Стабильная сезонность.

### 6.2. Класс B — средние

- 12–24 месяцев.
- Прогноз возможен, но с рисками.
- Широкие доверительные интервалы.

### 6.3. Класс C — не прогнозируемые

- < 12 месяцев.
- < 30% месяцев с ненулевой активностью.
- Филиал часто останавливался.
- Структурные изменения.

### 6.4. Причины отбраковки

- `short_history`
- `sparse_data`
- `stopped_branch`
- `structural_change`

---

## 7. ML-подход

### 7.1. Бейзлайны

- **Naive Last Year**
- **Moving Average (3/6/12)**
- Комбинация бейзлайнов

### 7.2. Основная модель

- **Глобальная модель** (CatBoost / LightGBM).
- Признаки:
  - лаги 1–12,
  - rolling mean/sum,
  - месяц/квартал,
  - возраст филиала,
  - активность,
  - дебиторка,
  - сезонность.

### 7.3. Персональные модели

- Для крупных филиалов класса A — при необходимости.

### 7.4. Группировка филиалов

- MVP: rule-based сегментация.
- v2: кластеризация временных рядов (DTW/shape-based).

### 7.5. Обучение

- **Раз в месяц**.
- Валидация — скользящим окном.
- Логирование результатов в **MLflow**.

---

## 8. Архитектура

### 8.1. Логическая схема

1. **Сбор данных**  
   Airflow → загрузка файла → Postgres
2. **Препроцессинг**  
   агрегации, фичи, аномалии
3. **Классификация филиалов A/B/C**
4. **Обучение моделей**  
   MLflow tracking
5. **Скоринг (1–3 месяца)**  
   доверительные интервалы
6. **Запись в Postgres**
7. **FastAPI сервис**
   - REST API
   - веб-интерфейс
8. **Мониторинг и алерты**

### 8.2. Технологии

- Python
- Airflow
- Postgres
- MLflow
- FastAPI

---

## 9. Мониторинг и алерты

### 9.1. Данные

- Плотность данных
- Количество C-филиалов
- Аномалии

### 9.2. Модели

- MAPE, MAE, WAPE
- Coverage по доверительным интервалам
- Сравнение с бейзлайном и ручным прогнозом

### 9.3. Алерты

- Ошибки Airflow
- Резкое ухудшение качества
- Рост доли C-филиалов
- Каналы:
  - Email
  - Telegram

---

## 10. Риски и предположения

### 10.1. Риски

- Разреженность данных
- Структурные изменения филиалов
- Некорректные выгрузки
- Человеческий фактор в ручных прогнозах
- Сезонность может меняться

### 10.2. Предположения

- ERP/DWH — источник правды
- Прогноз — помесячный
- Вся система работает on-prem
- Глубина данных достаточна для построения MVP

---

## 11. Roadmap

### MVP

- EDA + критерии A/B/C
- Пайплайн загрузки данных
- Бейзлайны
- Глобальная модель
- Месячный DAG (обучение+скоринг)
- FastAPI API + UI
- MLflow логирование
- Сравнение с ручным прогнозом

### Версия 1.0

- Улучшение моделей
- Улучшенный UI
- Алерты (email + Telegram)
- Функции по кассовым разрывам
- CI/CD и документация

### Версия 2.0

- Иерархический прогноз
- Кластеризация филиалов
- Внешние данные (рынок металла)
- Моделирование других статей ДДС

---

# ML System Design Doc — TS Forecast — MVP — Итерация 1

Шаблон: Reliable ML (RU)

---

## 1. Цели и предпосылки

## 1.1. Зачем идём в разработку продукта?

### Бизнес-цель (Product Owner)

Создать систему прогнозирования **отгрузок**, **оплат** и потенциальных
**кассовых разрывов** по каждому из 100+ филиалов. Цель — повысить точность
финансового планирования, минимизировать кассовые разрывы и снизить
зависимость от ручных прогнозов филиалов.

### Почему станет лучше (Product Owner + Data Scientist)

Сегодня каждый филиал вручную прогнозирует на ближайший месяц, прогнозы
разрознены и непоследовательны.  
После внедрения TS Forecast появится:

- единая методология прогнозирования,
- автоматические модели, обученные на многолетних исторических данных,
- единая визуализация с доверием и интервалами,
- понятное качество прогнозов по филиалам.

### Что считаем успехом итерации (Product Owner)

- Модельные прогнозы точнее бейзлайна на ≥ 60% филиалов.
- Прогноз на 1 месяц строится для ≥ 60% филиалов.
- Дашборд с визуализацией прогнозов и ручных вводов доступен и используется финдиректором.
- Филиалы классифицируются в A/B/C, причины отбраковки прозрачны.

---

## 1.2. Бизнес-требования и ограничения

### Бизнес-требования

- Прогнозировать суммы **отгрузок** и **поступлений оплат** по каждому филиалу.
- Горизонт: обязательный — 1 месяц, дополнительный — 2–3 месяца.
- Выдавать доверительные интервалы.
- Делить филиалы на классы A/B/C.
- Показывать сравнение с:
  - ручным прогнозом филиалов,
  - бейзлайном.
- Возможность использовать прогнозы финдиректором в процессе планирования.

### Бизнес-ограничения

- Все процессы — строго **on-prem**.
- Данные загружаются раз в месяц.
- Сильная вариативность длины временных рядов.
- Некоторые филиалы имеют долгие простои.

### Описание бизнес-процесса пилота

1. После закрытия месяца поступает выгрузка.
2. TS Forecast строит прогнозы и классификацию филиалов.
3. Финдир и казначейство используют прогнозы для планирования.
4. Сравнивают результаты модели с ручными прогнозами.

### Критерии успешного пилота

- Точность выше бейзлайна.
- Прогнозы используются в управленческом процессе.
- Классификация A/B/C отражает реальность по филиалам.
- Интерфейс понятен и удобен.

---

## 1.3. Скоуп / не скоуп / техдолг

### Входит в итерацию (Data Scientist)

- Прогноз отгрузок и оплат.
- Классификация A/B/C.
- Доверительные интервалы.
- Бейзлайн: Naive LY / MA(3/6/12).
- MVP-модель: глобальный CatBoost/LightGBM.
- Простая визуализация (FastAPI UI).
- Метрики в MLflow.

### Не входит

- Иерархический прогноз.
- Прогноз всех статей ДДС.
- Deep Learning модели.
- Персональные модели для каждого филиала (кроме экспериментов).

### Технический долг

- Гипертюнинг.
- Кастомная кластеризация филиалов.
- Улучшенный UI.
- Полное покрытие тестами.

### Качество реализации

- Воспроизводимый ML-пайплайн.
- Полное логирование шагов.
- Версионирование моделей в MLflow.

---

## 1.4. Предпосылки решения

- Горизонт: 1 месяц (2–3 месяца дополнительно).
- Гранулярность: филиал × месяц.
- Цели: `forecast_shipments`, `forecast_payments`.
- История: 6–48 месяцев.
- Сезонность выражена, аномалии редки.
- Обновление данных раз в месяц.
- Использование в финансовом планировании.

---

## 2. Методология (Data Scientist)

## 2.1. Постановка ML-задачи

### Тип задачи

Регрессия на временных рядах с табличными фичами (глобальная модель).

### Целевые переменные

1. Прогноз суммы отгрузок.
2. Прогноз суммы оплат.

### Связь с бизнесом

Точность прогноза напрямую влияет на корректность оценки платежной позиции и избегание кассовых разрывов.

---

## 2.2. Блок-схема решения

### Бейзлайн

1. Агрегация данных: филиал × месяц.
2. Naive Last Year (t-12).
3. MA(3/6/12).
4. Расчёт MAPE/MAE.
5. Отбор филиалов с хорошей сезонностью.

### MVP

1. Подготовка данных.
2. Feature engineering:
   - лаги (1–12),
   - rolling mean/sum,
   - сезонность,
   - флаги активности,
   - дебиторка.
3. Классификация филиалов A/B/C.
4. Обучение CatBoost/LightGBM.
5. Rolling backtesting.
6. CI.
7. Скоринг 1–3 месяцев.
8. Запись в витрину и визуализация в UI.

---

## 2.3. Этапы решения задачи

### Этап 1 — Подготовка данных

| Данные              | Источник     | Роли  | Качество |
| ------------------- | ------------ | ----- | -------- |
| Транзакции отгрузок | CSV выгрузка | DE/DS | +        |
| Транзакции оплат    | CSV          | DE/DS | +        |
| Дебиторка           | CSV          | DE/DS | ±        |
| Справочник филиалов | ERP          | DE    | +        |

**Выход:** витрина `branch_monthly_metrics`.

---

### Этап 2 — Бейзлайн

**Методы:** Naive LY, MA(3/6/12).  
**Метрики:** MAPE/MAE.  
**Риски:** отсутствие устойчивой сезонности.  
**Выход:** baseline metrics.

---

### Этап 3 — Feature Engineering

Фичи:

- лаги 1–12,
- MA/rolling,
- месяц/квартал,
- активность,
- дебиторка.

**Выход:** `features_prepared`.

---

### Этап 4 — MVP обучение

**Алгоритм:** CatBoost/LightGBM.  
**CV:** Rolling window.  
**Результат:** модель зарегистрирована в MLflow.  
**Риски:** нехватка данных у части филиалов.

---

### Этап 5 — Интерпретация

- feature importance,
- анализ ошибок по филиалам,
- сравнение с ручными прогнозами.

---

### Этап 6 — Интеграция бизнес-правил

- Класс C → прогноз не выдаём.
- Широкие CI → пометка «низкая уверенность».
- Длительные простои → автоматическая классификация C.

---

### Этап 7 — Инференс

- скоринг,
- CI,
- запись в Postgres,
- API в FastAPI.

---

### Этап 8 — Финальный отчёт

- сравнение с бейзлайном,
- качество по A/B филиалам,
- доля C-филиалов.

---

## 3. Подготовка пилота

## 3.1. Дизайн пилота

- Сравнение модели с ручными прогнозами.
- Оценка MAPE/WAPE за последние 12 месяцев.
- Анализ корректности классификации A/B/C.

## 3.2. Метрики успеха пилота

- ≥ 60% филиалов: модель лучше бейзлайна.
- ≤ 30% филиалов: класс C.
- Coverage ≥ 80%.
- Финдир использует прогнозы в планировании.

## 3.3. Вычислительная сложность

- Обучение: 1–3 мин.
- Скоринг: < 30 сек.
- DAG: < 10 мин.
- GPU не требуется.

---

## 4. Внедрение для production

## 4.1. Архитектура решения

Airflow → Postgres → Feature Prep → MLflow → Scoring → FastAPI → UI  
(Диаграмма находится в `docs/ts_forecast_architecture.svg`)

## 4.2. Инфраструктура и масштабируемость

**Выбрано:** on-prem Airflow + Postgres + MLflow + FastAPI.  
**Причины:** безопасность, стоимость, простота эксплуатации.  
**Альтернативы:** Kubeflow (избыточно), Spark (не нужен).

## 4.3. Требования к системе (SLA)

- Обновление прогноза: раз в месяц до 10:00.
- API latency < 300 мс.
- Доступность ≥ 99%.

## 4.4. Безопасность системы

- доступ по VPN,
- логирование всех операций,
- ролевой доступ.

## 4.5. Безопасность данных

- Персональных данных нет.
- GDPR не применим.
- Данные не покидают периметр.

## 4.6. Издержки

- Compute: < 2 CPU·ч / месяц.
- Storage: < 1 ГБ.
- Поддержка: 2–4 ч / месяц.

## 4.7. Integration points

API FastAPI:

- `GET /forecast/{branch_id}`
- `GET /forecast/network_summary`
- `GET /branches/status`
- `GET /metrics/model_quality`

## 4.8. Риски внедрения

- низкое качество данных отдельных филиалов,
- задержки выгрузки,
- непринятие модели пользователями,
- структурные изменения филиалов.

---

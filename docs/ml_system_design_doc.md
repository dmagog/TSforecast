# ML System Design Doc — TS Forecast — MVP — Итерация 2

Шаблон: Reliable ML (RU)

---

# 1. Цели и предпосылки

## 1.1. Зачем идём в разработку продукта?

### Бизнес-цель (Product Owner)

Создать систему прогнозирования факта месячных **отгрузок** и **поступлений оплат** по каждому из 100+ филиалов, которая используется в процессе планирования ликвидности и управления кассовыми разрывами.

Ключевые бизнес-цели:

- обеспечить точность прогноза факта месяца в пределах **±10%** для филиалов, допущенных к прогнозированию;
- снизить риск кассовых разрывов, связанных с **переоценкой ожидаемых поступлений**, за счёт использования доверительных интервалов и консервативной оценки притока денежных средств;
- сократить трудозатраты на подготовку прогноза: с **1–3 рабочих дней ручной работы менеджеров** до **автоматического расчёта в течение нескольких минут по фиксированному расписанию**.

Достижение этих целей позволяет стандартизировать процесс прогнозирования по всей сети филиалов, повысить управляемость финансового планирования и снизить зависимость от индивидуальной экспертности отдельных сотрудников.

### Почему станет лучше (Product Owner + Data Scientist)

Сейчас прогноз на месяц делается вручную в каждом филиале, с разной квалификацией исполнителей. Отгрузки и оплаты несинхронны, лаг может составлять 2–3 месяца. Из-за неоднородности данных и человеческого фактора повышается риск ошибочного планирования ликвидности, особенно при переоценке поступлений.

ML-система обеспечит:

- единые правила прогнозирования и контроля качества,
- сопоставимость филиалов между собой,
- доверительные интервалы (оценка неопределенности),
- автоматическую отбраковку филиалов, по которым прогноз сейчас ненадёжен.

### Что считаем успехом итерации (Product Owner)

- Для не менее чем 60% филиалов прогноз MVP-модели демонстрирует лучшую точность по сравнению с формализованным бейзлайном, рассчитанным на тех же данных и горизонтах.
- Прогноз на 1 месяц строится для большинства филиалов с историей > 12 месяцев.
- Для значимой доли филиалов качество прогноза соответствует целевым порогам (A/B).
- Система объясняет причины отнесения филиала к A/B/C.
- Финдиректор и казначейство используют прогнозы в планировании на протяжении пилота (несколько месяцев).

---

## 1.2. Бизнес-требования и ограничения

### Бизнес-требования

- Прогнозировать **факт месяца** по отгрузкам и оплатам в разрезе филиалов.
- Горизонт: обязательный — +1 месяц; расширенный — +2–3 месяца (контроль/бонус).
- Возвращать точечный прогноз и доверительный интервал.
- Сравнивать прогнозы: MVP vs бейзлайн vs ручной прогноз менеджера.
- Автоматически классифицировать филиалы по качеству прогнозирования (A/B/C) и отображать причины отбраковки.

### Бизнес-ограничения

- Решение разворачивается on-prem во внутреннем контуре заказчика.
- Обновление данных и пересчёт прогнозов — раз в месяц, в фиксированное время.
- Временные ряды сильно неоднородны по глубине и плотности.
- Для бизнеса **переоценка поступлений хуже недооценки**, так как ведёт к недостаточному планированию кредитного покрытия кассовых разрывов.

### Описание бизнес-процесса пилота

1. Закрытие месяца → загрузка данных.
2. Построение прогнозов (бейзлайн + MVP) и классификация A/B/C (по формальным критериям качества прогнозирования, стабильности временных рядов и достаточности данных для принятия управленческих решений).
   Сегментация используется для определения допустимой стратегии работы с филиалом:
   - класс A — прогноз используется в продакшене;
   - класс B — прогноз используется с ограничениями и дополнительным контролем;
   - класс C — прогноз не отдаётся в продакшен, филиал требует ручного анализа или накопления данных.

3. Параллельно менеджеры продолжают вводить ручной прогноз. (Ручной прогноз менеджеров используется как текущий бизнес-референс и участвует в пилоте для оценки выигрыша от автоматизации, однако не рассматривается как формализованный бейзлайн из-за отсутствия воспроизводимости и единой методологии.)
4. Финдиректор/казначейство анализируют расхождения, доверие к прогнозу, долю C-филиалов.

### Критерии успешного пилота

- для филиалов, допущенных к прогнозированию, ошибка прогноза факта месяца не превышает ±10% в целевом сегменте;
- доля филиалов с ошибкой >15% снижается по сравнению с текущим процессом ручного прогнозирования;
- риск систематической переоценки поступлений снижен (смещение прогноза не положительное);
- время подготовки прогноза сокращено с 1–3 рабочих дней до автоматического расчёта по расписанию.
- по итогам пилота финдиректор и казначейство принимают обоснованное решение о целесообразности использования прогнозов в регулярном финансовом планировании;
- результаты пилота позволяют определить перечень филиалов (A/B), для которых прогноз может быть использован в управленческих решениях на следующей итерации.

---

## 1.3. Скоуп / не скоуп / техдолг

### Входит в итерацию (Data Scientist)

- Прогноз отгрузок и оплат (факт месяца).
- Формализованный бейзлайн: Naive Last Year (t-12) и Moving Average (3/6/12).
- Референс для бизнес-сравнения: ручной прогноз филиальных менеджеров.
- MVP-модель: глобальная модель (CatBoost/LightGBM) с табличными фичами.
- Доверительные интервалы и маркеры уверенности.
- Классификация филиалов A/B/C по качеству прогноза и формальным признакам данных.
- UI/BI внутри веб-сервиса (минимально необходимый функционал).
- Мониторинг качества, дрейфа и стабильности пайплайна.

### Не входит

- Иерархический прогноз — исключён на текущей итерации, так как бизнес-задача формулируется в разрезе отдельных филиалов, а агрегирование по уровням не используется в процессе принятия решений.
- Прогноз всех статей ДДС — за пределами текущей бизнес-цели, фокус итерации ограничен отгрузками и оплатами.
- Deep Learning модели — не рассматриваются в MVP из-за ограниченного объёма данных по части филиалов и требования к интерпретируемости.
- Персональные модели для каждого филиала — не являются базовой стратегией из-за сильной неоднородности и недостаточной глубины данных; глобальная модель с фильтрацией филиалов выбрана как основной подход.

### Технический долг

- Гипертюнинг и автоматический подбор гиперпараметров.
- Автокластеризация филиалов и transfer-подходы для малых рядов.
- Расширенная аналитика кассовых разрывов и сценарный анализ.
- Полное покрытие тестами и расширенные алерты.

### Качество реализации

- Воспроизводимый пайплайн (Airflow DAG end-to-end).
- Логирование экспериментов и регистрация моделей в MLflow.
- Версионирование моделей и метрик, сохранение артефактов.

---

## 1.4. Предпосылки решения

- Гранулярность: филиал × месяц.
- Цели: прогноз суммы отгрузок и суммы оплат за месяц (факт).
- Нулевые значения трактуются как реальная нулевая активность.
- Минимальная история для допуска в прогнозирование: **> 12 месяцев**.
- C-филиалы — «пока не прогнозируем в проде»; при накоплении данных филиал может перейти в B/A.
- Пороговые значения качества (по MAPE, целевой ориентир бизнеса):
  - ≤ 10% — хороший прогноз,
  - 10–15% — допустимый,
  - > 15% — плохой (для продакшена не отдаём).

---

# 2. Методология (Data Scientist)

## 2.1. Постановка задачи

### Тип задачи

Прогнозирование временных рядов (регрессия) на агрегированных помесячных данных. Подход: глобальная модель с табличными признаками + правила допуска/отбраковки филиалов.

### Целевые переменные

1. `shipments_amount_month` — сумма отгрузок филиала за месяц
2. `payments_amount_month` — сумма оплат филиала за месяц

### Особенности, влияющие на методологию

- неоднородность филиалов (объемы, плотность данных, глубина истории),
- возможные паузы в работе,
- выраженная сезонность,
- бизнес-асимметрия ошибок: переоценка поступлений хуже.

### Связь с бизнесом

Точность прогноза (в терминах MAPE) напрямую влияет на качество планирования ликвидности:

- ошибка прогноза поступлений >15% приводит к систематической переоценке доступных денежных средств и риску недофинансирования кассовых разрывов;
- достижение точности в пределах ±10% позволяет заранее и обоснованно планировать привлечение кредитного финансирования, а также снижает количество внеплановых корректировок финансового плана;
- снижение доли филиалов с высокой ошибкой (>15%) уменьшает неопределённость при агрегировании прогнозов на уровне сети и повышает доверие к автоматизированному процессу.

---

## 2.2. Блок-схема решения (бейзлайн vs MVP)

Решение строится как итеративный процесс, в котором результаты анализа данных и оценки качества моделей могут приводить к возврату на предыдущие этапы (корректировка признаков, критериев отбора филиалов и параметров моделей).

### Бейзлайн (роль: сравнение; допускается как рабочее решение для части филиалов)

1. Агрегация транзакций до филиал × месяц.
2. Naive Last Year: прогноз = значение t-12 (для сезонности).
3. Moving Average: MA(3/6/12) как альтернатива для сглаживания.
4. Расчёт метрик качества прогноза (MAPE, MAE) для первичной оценки точности и сопоставимости филиалов; выбор и интерпретация метрик уточняются по результатам EDA с учётом распределения целевой переменной и бизнес-риска переоценки поступлений.
5. Выбор «лучшего простого прогноза» для сравнения с MVP; допускается оставить бейзлайн как приоритетный вариант для отдельных филиалов, если он стабильно лучше.

Метрики используются не изолированно, а в связке с доверительными интервалами и анализом ошибок, так как для бизнеса критична не только средняя ошибка, но и риск систематической переоценки притока денежных средств.

### MVP

1. Подготовка витрины данных и EDA (см. 2.3, этап 1).
   Результаты разведочного анализа данных используются для:

- определения минимальной глубины истории для прогнозирования,
- выявления филиалов с высокой долей нулевой активности,
- уточнения набора признаков и правил фильтрации данных,
- формирования критериев классификации филиалов A/B/C.

2. Feature engineering:
   - лаги (1–12 месяцев), отражающие краткосрочную динамику и годовую сезонность, выявленную в ходе EDA на помесячных данных,
   - скользящие статистики (rolling mean/sum и другие агрегаты при необходимости), рассчитываемые по временным окнам для сглаживания шума и учёта локальной динамики,
   - сезонность (месяц, квартал),
   - признаки активности/простоя,
   - признаки по дебиторке (если качество достаточно).
3. Обучение глобальных моделей (shipments/payments) + backtesting.
4. Оценка качества по филиалам и формирование доверительных интервалов.
5. Классификация филиалов A/B/C и выдача причин.
6. Скоринг на 1–3 месяца, запись в витрину, UI.
7. Пилот: сравнение с ручными прогнозами менеджеров.
8. Подготовка пайплайна к регулярному запуску и развёртыванию. Включает автоматизацию запуска, контроль воспроизводимости расчётов и готовность к регулярному пересчёту прогнозов.

Для филиалов с географической и операционной неоднородностью допускается использование агрегированных скользящих статистик по группам филиалов на этапе экспериментов.

---

## 2.3. Этапы решения задачи (подробно, отдельно бейзлайн и MVP)

### Этап 1 — Подготовка данных и EDA

**Цель этапа:** оценить состав, объем и качество данных и определить правила допуска филиалов в прогнозирование.

**Артефакты EDA (в репозитории):**

- `/eda/spk-v3-extract-final.ipynb`
- `/eda/spk-v3-action-4-final.ipynb`

**Данные и сущности**

| Название данных          | Источник           | Роли  | Качество проверено |
| ------------------------ | ------------------ | ----- | ------------------ |
| Транзакции отгрузок      | CSV выгрузка / DWH | DE/DS | да                 |
| Транзакции оплат         | CSV выгрузка / DWH | DE/DS | да                 |
| Дебиторка (нач/кон)      | CSV выгрузка / DWH | DE/DS | частично           |
| Справочник филиалов      | ERP/DWH            | DE    | да                 |
| Ручной прогноз менеджера | внутренний ввод    | PO/DS | да (наличие)       |

**Атрибутивное описание данных и инсайты после EDA:**

- временная гранулярность: помесячные агрегаты по филиалам;
- целевые показатели (отгрузки, оплаты) имеют правосторонне-асимметричное распределение с редкими крупными значениями;
- нулевые значения интерпретируются как отсутствие операционной активности филиала в месяце;
- глубина исторических данных варьируется от 6 месяцев до 4+ лет разной степенью ценности;
- плотность данных существенно различается: от регулярных операций до разовых крупных сделок;
- годовая сезонность выявлена для части филиалов, но отсутствует или нестабильна для других;
- для части филиалов наблюдаются периоды полной остановки активности.

Данные выводы используются для:

- определения минимальной глубины истории (>12 месяцев) для допуска к прогнозированию;
- формирования критериев сегментации филиалов A/B/C;
- выбора бейзлайнов и стратегий прогнозирования.

**Минимальный набор визуализаций и выводов (EDA):**

- распределение глубины истории по филиалам (кол-во месяцев),
- доля месяцев с нулевой активностью по филиалам,
- примеры рядов для активных/разреженных филиалов,
- сезонность (средние значения по месяцам),
- первичная проверка выбросов/аномалий,
- сопоставление “отгрузки vs оплаты” на уровне сети/групп филиалов.

**Ключевые выводы EDA (фиксируем в документе):**

- есть филиалы с историей < 12 месяцев → не допускаются в прод-прогнозирование,
- нулевые значения — нормальная нулевая активность, а не пропуск,
- часть филиалов имеет длительные простои/разреженность → риск нестабильного прогноза,
- сезонность выражена, но неоднородна по филиалам,
- необходим механизм классификации A/B/C и прозрачные причины.

**Бизнес-проверка:** финдиректор подтверждает правила допуска/отбраковки и пороги качества.

---

### Этап 2 — Бейзлайн

**Назначение бейзлайна:**

- формализованная точка сравнения для MVP на единых правилах и воспроизводимых расчётах;
- выбор «лучшего простого метода» как допустимой рабочей стратегии для части филиалов, если он стабильно точнее MVP;
- отдельный референс для бизнеса — ручной прогноз менеджера используется в пилоте для оценки эффекта автоматизации, но не является формализованным бейзлайном из-за отсутствия единой методологии и воспроизводимости.

**Бейзлайн-методы (выбираются после EDA и могут отличаться по филиалам):**

- Naive Last Year (t-12) — применяется для рядов с подтверждённой годовой сезонностью;
- Moving Average MA(3/6/12) — применяется как более устойчивый вариант для шумных рядов и рядов без стабильной сезонности.

**Оценка качества (валидация):**

- rolling backtesting (walk-forward) на помесячных данных без перемешивания;
- качество считаем по каждому филиалу отдельно и агрегируем по группам (A/B/C).

**Метрики качества и связь с бизнесом:**

- основная метрика для сравнения по филиалам: MAPE (соотносится с бизнес-порогами точности ±10% / 10–15% / >15%);
- MAE используется как дополнительная, чтобы контролировать абсолютную ошибку на крупных филиалах;
- WAPE/взвешенная ошибка по сети применяется для агрегированной оценки, чтобы крупные филиалы имели пропорциональный вклад.

**Результат этапа:**

- таблица метрик и стабильности качества по филиалам;
- выбранный бейзлайн-кандидат для каждого филиала (лучший из простых по rolling backtesting);
- перечень филиалов, для которых ни один простой метод не достигает приемлемого качества и/или демонстрирует нестабильность → кандидаты в класс C.

**Риски и действия:**

- отсутствие устойчивой сезонности (по результатам EDA встречается у части филиалов) → Naive LY ухудшается; используем MA как более устойчивый вариант или переводим филиал в C;
- высокая разреженность/нулевая активность в ряде месяцев → деградация качества и рост неопределённости; усиливаем критерии допуска и используем доверительные интервалы на следующих этапах.

**Бизнес-проверка:**

- подтверждаем с финдиректором пороги приемлемого качества (±10% как целевой) и правила выбора стратегии: MVP vs «лучший бейзлайн»;
- согласовываем, что для класса C прогноз в прод не отдаётся, причины отбраковки отображаются явно.

---

### Этап 3 — Формирование признаков (MVP)

**Признаки:**

- лаги 1–12 по целевой,
- rolling sum/mean (3/6/12),
- сезонность: month_of_year, quarter,
- признаки операционной активности филиала (доля месяцев с ненулевыми отгрузками/оплатами за скользящее окно, флаг наличия активности в текущем и предыдущих периодах),
- признаки по дебиторке (если качество подтверждено).

**Результат этапа:**

- обучающая матрица признаков + спецификация фичей,
- правила обработки редких/нулевых значений.

**Риски:**

- leakage при формировании признаков → строгое соблюдение временной причинности.

---

### Этап 4 — Обучение и валидация MVP

**Алгоритмы:**

- CatBoost и LightGBM рассматриваются как кандидаты для MVP;
- для каждого типа данных и группы филиалов проводится обучение и сравнение моделей;
- финальный выбор алгоритма осуществляется по результатам rolling backtesting с учётом качества прогноза и стабильности ошибок.

**Схема валидации:**

- walk-forward (rolling) валидация на временных рядах без перемешивания данных;
- обучение проводится на нарастающем окне исторических данных (минимум 12 месяцев);
- тестирование — на следующем месяце (горизонт прогноза 1 месяц);
- схема повторяется для последовательных временных срезов до конца доступной истории.

**Метрики и пороги (связаны с бизнесом):**

- целевой ориентир: MAPE ≤ 10% (A),
- допустимо: 10–15% (B),
- плохо: > 15% (C) — не отдаём прогноз в прод.

**Результат этапа:**

- обученные и провалидированные модели-кандидаты с оценкой качества и стабильности по филиалам;
- сравнение алгоритмов и конфигураций по rolling backtesting;
- выбор модели (или набора моделей), удовлетворяющих бизнес-порогам качества;
- фиксация результатов экспериментов и выбранных моделей в MLflow.

**Риски и обработка:**

- для филиалов с недостаточной глубиной или плотностью данных обучение персональных моделей не проводится;
- такие филиалы обрабатываются через бейзлайны либо исключаются из прогнозирования и относятся к классу C;
- по результатам EDA возможны эксперименты с использованием агрегированных признаков или глобальной модели без ухудшения управляемости риска.

**Бизнес-проверка:** согласование границ A/B/C и правил “MVP vs бейзлайн”.

---

### Этап 5 — Доверительные интервалы и интерпретация

**Цель:**

- дать пользователю оценку неопределенности прогноза,
- снизить риск управленческих ошибок при использовании точечного прогноза.

**Подходы (MVP):**

- оценка доверительных интервалов через:
  - квантили (quantile regression), либо
  - эмпирическое распределение ошибок, полученное на rolling backtesting (бутстрэп/перцентильная оценка);
- интерпретация результатов осуществляется на уровне неопределённости прогноза, а не вклада отдельных признаков.

**Результат:**

- точечный прогноз с доверительными интервалами (например, 80% и 95%);
- маркер “низкая уверенность” для филиалов и периодов с чрезмерно широкими интервалами;
- дополнительный сигнал для классификации филиалов (A/B/C) и управленческих решений.

---

### Этап 6 — Классификация филиалов A/B/C и правила выдачи прогнозов

**Принцип (автоматический):**

- класс определяется на основе качества backtesting и формальных критериев данных.

**Критерии (минимальный набор):**

- глубина истории > 12 месяцев,
- доля активных месяцев,
- качество модели (MAPE).

**Выдача прогнозов:**

- A/B: отдаём прогноз (MVP или бейзлайн — что лучше по backtesting),
- C: прогноз в прод не отдаём; в пилоте можем продолжать считать для контроля и сравнения с ручными прогнозами.

**Объяснение причин отбраковки (пример):**

- “история < 12 месяцев”,
- “высокая доля нулевых месяцев → нестабильность”,
- “MAPE > 15% на backtesting”,
- “слишком широкий CI”.

---

### Этап 7 — Инференс

На этапе инференса выполняется регулярный расчёт прогнозов для всех филиалов, допущенных к прогнозированию.

Последовательность действий:

- загрузка актуальных данных за завершившийся месяц;
- формирование признаков по утверждённому пайплайну;
- применение выбранной модели или бейзлайна для каждого филиала;
- расчёт точечного прогноза на следующий месяц;
- расчёт доверительных интервалов для оценки неопределённости;
- сохранение результатов в витрину прогнозов и подготовка данных для интерфейса.

Инференс выполняется автоматически по расписанию (раз в месяц).

---

### Этап 8 — Итоговый отчёт по итерации

- сравнение с бейзлайном,
- сравнение с ручными прогнозами,
- доля A/B/C и динамика,
- рекомендации по улучшениям (включая кандидатов на кластеризацию и отдельные модели).

---

# 3. Подготовка пилота

## 3.1. Дизайн пилота

Пилот проводится в “параллельном” режиме: система строит прогнозы, менеджеры продолжают вводить ручной прогноз. Результаты используются в планировании, но решение о доверии к прогнозу принимается постепенно на горизонте нескольких месяцев.

## 3.2. Что считаем успешным пилотом

- Значимая доля филиалов в A/B по итогам backtesting (ориентир: MAPE ≤ 15% для большинства допущенных филиалов).
- MVP не хуже бейзлайна в среднем, а в ряде филиалов лучше.
- Управляемая доля C-филиалов с понятными причинами.
- Финдиректор подтверждает применимость прогнозов в регулярном планировании.

## 3.3. Ограничения по вычислениям

- обучение: batch-режим по расписанию; жёстких требований по времени нет, целевой ориентир — укладываться в ночное/плановое окно запуска Airflow с учётом rolling backtesting и подбора параметров;
- скоринг: batch-расчёт прогнозов по всем филиалам; требования к latency мягкие, целевой ориентир — завершение расчёта в рамках регламентного запуска (порядка минут, а не секунд) и готовность результатов к началу рабочего дня;
- обновление: один раз в месяц (переобучение и пересчёт прогнозов в выбранный день/время);
- ресурсы: CPU-достаточно; GPU не требуется на MVP (табличные модели/квантили).

---

# 4. Внедрение для production

## 4.1. Архитектура решения

Архитектура построена вокруг batch-пайплайнов, оркестрируемых через Airflow, с разделением этапов обучения и инференса.

- **Airflow** — оркестрация пайплайнов обучения и инференса (отдельные DAG);
- **Postgres** — хранение исходных данных и агрегированных витрин;
- **Feature Prep** — формирование признаков (переиспользуемый код для обучения и инференса);
- **MLflow** — хранение артефактов моделей, параметров и метрик экспериментов;
- **Scoring** — batch-расчёт прогнозов и доверительных интервалов;
- **FastAPI** — слой доступа к результатам прогнозирования;
- **UI/BI** — визуализация прогнозов и метрик для пользователей.

(Диаграмма архитектуры находится в `docs/ts_forecast_architecture.svg`)

## 4.2. Инфраструктура и масштабируемость

**Выбрано:** on-prem Airflow + Postgres + MLflow + FastAPI.  
**Причины:** безопасность, стоимость, простота эксплуатации.  
**Альтернативы:** Kubeflow (избыточно), Spark (не нужен).

## 4.3. Требования к системе (SLA)

- Обновление прогноза: раз в месяц до 10:00.
- API latency < 300 мс.
- Доступность ≥ 99%.

## 4.4. Безопасность системы

- доступ по VPN,
- логирование всех операций,
- ролевой доступ.

## 4.5. Безопасность данных

- Персональных данных нет.
- GDPR не применим.
- Данные не покидают периметр.

## 4.6. Издержки

- Compute: < 2 CPU·ч / месяц.
- Storage: < 1 ГБ.
- Поддержка: 2–4 ч / месяц.

## 4.7. Integration points

API FastAPI:

- `GET /forecast/{branch_id}`
- `GET /forecast/network_summary`
- `GET /branches/status`
- `GET /metrics/model_quality`

## 4.8. Риски внедрения

- низкое качество данных отдельных филиалов,
- задержки выгрузки,
- непринятие модели пользователями,
- структурные изменения филиалов.

---

# Конец документа

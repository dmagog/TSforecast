# ML System Design Doc — TS Forecast — MVP — Итерация 2

Шаблон: Reliable ML (RU)

---

# 1. Цели и предпосылки

## 1.1. Зачем идём в разработку продукта?

### Бизнес-цель (Product Owner)

Создать систему прогнозирования **отгрузок** и **поступлений оплат** (факт месяца) по каждому из 100+ филиалов, чтобы снизить риск **кассовых разрывов** и сократить ручной труд филиальных менеджеров.

### Почему станет лучше (Product Owner + Data Scientist)

Сейчас прогноз на месяц делается вручную в каждом филиале, с разной квалификацией исполнителей. Отгрузки и оплаты несинхронны, лаг может составлять 2–3 месяца. Из-за неоднородности данных и человеческого фактора повышается риск ошибочного планирования ликвидности, особенно при переоценке поступлений.

ML-система обеспечит:

- единые правила прогнозирования и контроля качества,
- сопоставимость филиалов между собой,
- доверительные интервалы (оценка неопределенности),
- автоматическую отбраковку филиалов, по которым прогноз сейчас ненадёжен.

### Что считаем успехом итерации (Product Owner)

- Прогноз на 1 месяц строится для большинства филиалов с историей > 12 месяцев.
- Для значимой доли филиалов качество прогноза соответствует целевым порогам (A/B).
- Система объясняет причины отнесения филиала к A/B/C.
- Финдиректор и казначейство используют прогнозы в планировании на протяжении пилота (несколько месяцев).

---

## 1.2. Бизнес-требования и ограничения

### Бизнес-требования

- Прогнозировать **факт месяца** по отгрузкам и оплатам в разрезе филиалов.
- Горизонт: обязательный — +1 месяц; расширенный — +2–3 месяца (контроль/бонус).
- Возвращать точечный прогноз и доверительный интервал.
- Сравнивать прогнозы: MVP vs бейзлайн vs ручной прогноз менеджера.
- Автоматически классифицировать филиалы по качеству прогнозирования (A/B/C) и отображать причины отбраковки.

### Бизнес-ограничения

- Решение разворачивается on-prem во внутреннем контуре заказчика.
- Обновление данных и пересчёт прогнозов — раз в месяц, в фиксированное время.
- Временные ряды сильно неоднородны по глубине и плотности.
- Для бизнеса **переоценка поступлений хуже недооценки**, так как ведёт к недостаточному планированию кредитного покрытия кассовых разрывов.

### Описание бизнес-процесса пилота

1. Закрытие месяца → загрузка данных.
2. Построение прогнозов (бейзлайн + MVP) и классификация A/B/C.
3. Параллельно менеджеры продолжают вводить ручной прогноз.
4. Финдиректор/казначейство анализируют расхождения, доверие к прогнозу, долю C-филиалов.
5. По итогам нескольких месяцев принимается решение о допуске отдельных филиалов в production-прогнозирование.

---

## 1.3. Скоуп / не скоуп / техдолг

### Входит в итерацию (Data Scientist)

- Прогноз отгрузок и оплат (факт месяца).
- Бейзлайн: Naive LY (t-12), MA(3/6/12).
- MVP-модель: глобальная модель (CatBoost/LightGBM) с табличными фичами.
- Доверительные интервалы и маркеры уверенности.
- Классификация филиалов A/B/C по качеству прогноза и формальным признакам данных.
- UI/BI внутри веб-сервиса (минимально необходимый функционал).
- Мониторинг качества, дрейфа и стабильности пайплайна.

### Не входит

- Иерархический прогноз.
- Прогноз статей ДДС помимо отгрузок/оплат.
- Внешние факторы (курс валют/рынок металла) — как зона роста.
- Персональные модели на каждый филиал как обязательный стандарт (только при обосновании).

### Технический долг

- Гипертюнинг и автоматический подбор гиперпараметров.
- Автокластеризация филиалов и transfer-подходы для малых рядов.
- Расширенная аналитика кассовых разрывов и сценарный анализ.
- Полное покрытие тестами и расширенные алерты.

### Качество реализации

- Воспроизводимый пайплайн (Airflow DAG end-to-end).
- Логирование экспериментов и регистрация моделей в MLflow.
- Версионирование моделей и метрик, сохранение артефактов.

---

## 1.4. Предпосылки решения

- Гранулярность: филиал × месяц.
- Цели: прогноз суммы отгрузок и суммы оплат за месяц (факт).
- Нулевые значения трактуются как реальная нулевая активность.
- Минимальная история для допуска в прогнозирование: **> 12 месяцев**.
- C-филиалы — «пока не прогнозируем в проде»; при накоплении данных филиал может перейти в B/A.
- Пороговые значения качества (по MAPE, целевой ориентир бизнеса):
  - ≤ 10% — хороший прогноз,
  - 10–15% — допустимый,
  - > 15% — плохой (для продакшена не отдаём).

---

# 2. Методология (Data Scientist)

## 2.1. Постановка задачи

### Тип задачи

Прогнозирование временных рядов (регрессия) на агрегированных помесячных данных. Подход: глобальная модель с табличными признаками + правила допуска/отбраковки филиалов.

### Целевые переменные

1. `shipments_amount_month` — сумма отгрузок филиала за месяц
2. `payments_amount_month` — сумма оплат филиала за месяц

### Особенности, влияющие на методологию

- неоднородность филиалов (объемы, плотность данных, глубина истории),
- возможные паузы в работе,
- выраженная сезонность,
- бизнес-асимметрия ошибок: переоценка поступлений хуже.

---

## 2.2. Блок-схема решения (бейзлайн vs MVP)

### Бейзлайн (роль: сравнение; допускается как рабочее решение для части филиалов)

1. Агрегация транзакций до филиал × месяц.
2. Naive Last Year: прогноз = значение t-12 (для сезонности).
3. Moving Average: MA(3/6/12) как альтернатива для сглаживания.
4. Backtesting (rolling): оценка MAPE/MAE/WAPE по филиалам.
5. Выбор «лучшего простого прогноза» для сравнения с MVP; допускается оставить бейзлайн как приоритетный вариант для отдельных филиалов, если он стабильно лучше.

### MVP

1. Подготовка витрины данных и EDA (см. 2.3, этап 1).
2. Feature engineering:
   - лаги 1–12,
   - rolling mean/sum,
   - сезонность (месяц, квартал),
   - признаки активности/простоя,
   - признаки по дебиторке (если качество достаточно).
3. Обучение глобальных моделей (shipments/payments) + backtesting.
4. Оценка качества по филиалам и формирование доверительных интервалов.
5. Классификация филиалов A/B/C и выдача причин.
6. Скоринг на 1–3 месяца, запись в витрину, UI.
7. Пилот: сравнение с ручными прогнозами менеджеров.

---

## 2.3. Этапы решения задачи (подробно, отдельно бейзлайн и MVP)

### Этап 1 — Подготовка данных и EDA

**Цель этапа:** оценить состав, объем и качество данных и определить правила допуска филиалов в прогнозирование.

**Артефакты EDA (в репозитории):**

- `notebooks/eda/01_data_overview.ipynb`
- `notebooks/eda/02_branch_activity.ipynb`
- `notebooks/eda/03_seasonality_anomalies.ipynb`  
  (пути предлагаемые; финальные пути фиксируются в репозитории)

**Данные и сущности**

| Название данных          | Источник           | Роли  | Качество проверено |
| ------------------------ | ------------------ | ----- | ------------------ |
| Транзакции отгрузок      | CSV выгрузка / DWH | DE/DS | да                 |
| Транзакции оплат         | CSV выгрузка / DWH | DE/DS | да                 |
| Дебиторка (нач/кон)      | CSV выгрузка / DWH | DE/DS | частично           |
| Справочник филиалов      | ERP/DWH            | DE    | да                 |
| Ручной прогноз менеджера | внутренний ввод    | PO/DS | да (наличие)       |

**Минимальный набор визуализаций и выводов (EDA):**

- распределение глубины истории по филиалам (кол-во месяцев),
- доля месяцев с нулевой активностью по филиалам,
- примеры рядов для активных/разреженных филиалов,
- сезонность (средние значения по месяцам),
- первичная проверка выбросов/аномалий,
- сопоставление “отгрузки vs оплаты” на уровне сети/групп филиалов.

**Ключевые выводы EDA (фиксируем в документе):**

- есть филиалы с историей < 12 месяцев → не допускаются в прод-прогнозирование,
- нулевые значения — нормальная нулевая активность, а не пропуск,
- часть филиалов имеет длительные простои/разреженность → риск нестабильного прогноза,
- сезонность выражена, но неоднородна по филиалам,
- необходим механизм классификации A/B/C и прозрачные причины.

**Бизнес-проверка:** финдиректор подтверждает правила допуска/отбраковки и пороги качества.

---

### Этап 2 — Бейзлайн

**Бейзлайн-методы:**

- Naive Last Year (t-12),
- MA(3/6/12) как альтернативы.

**Оценка качества:**

- по филиалам: MAPE, MAE (и/или WAPE для агрегатов),
- backtesting: rolling window.

**Результат этапа:**

- таблица метрик по филиалам,
- выбранный бейзлайн-кандидат для каждого филиала (лучший из простых),
- список филиалов, где бейзлайн приемлем/неприемлем.

**Риск и что делаем:**

- слабая сезонность → Naive может быть плох; в этом случае MA или отказ (C).

**Бизнес-проверка:** обсуждение интерпретируемости и приемлемости простых моделей.

---

### Этап 3 — Формирование признаков (MVP)

**Признаки (примерный перечень):**

- лаги 1–12 по целевой,
- rolling sum/mean (3/6/12),
- сезонность: month_of_year, quarter,
- флаги активности (например: доля нулевых месяцев за окно),
- признаки по дебиторке (если качество подтверждено).

**Результат этапа:**

- обучающая матрица признаков + спецификация фичей,
- правила обработки редких/нулевых значений.

**Риски:**

- leakage при формировании признаков → строгое соблюдение временной причинности.

---

### Этап 4 — Обучение и валидация MVP

**Алгоритмы:**

- CatBoost / LightGBM (регрессия).

**Схема валидации:**

- rolling window (walk-forward) по времени, без перемешивания.

**Метрики и пороги (связаны с бизнесом):**

- целевой ориентир: MAPE ≤ 10% (A),
- допустимо: 10–15% (B),
- плохо: > 15% (C) — не отдаём прогноз в прод.

**Дополнительно про риск переоценки:**

- в отчёте отдельно анализируем случаи переоценки оплат,
- при прочих равных приоритет отдаётся модели/настройке, уменьшающей риск переоценки (консервативная верхняя оценка через CI и правила).

**Результат этапа:**

- зарегистрированные модели в MLflow,
- отчёт по качеству по филиалам.

**Бизнес-проверка:** согласование границ A/B/C и правил “MVP vs бейзлайн”.

---

### Этап 5 — Доверительные интервалы и интерпретация

**Цель:**

- дать пользователю оценку неопределенности,
- снизить риск неверных решений при “точечном” прогнозе.

**Подходы (MVP):**

- квантили (quantile regression) или
- бутстрэп/эмпирическая оценка ошибок на backtesting.

**Результат:**

- прогноз + CI (например, 80%/95%),
- маркер “низкая уверенность” при слишком широких интервалах.

---

### Этап 6 — Классификация филиалов A/B/C и правила выдачи прогнозов

**Принцип (автоматический):**

- класс определяется на основе качества backtesting и формальных критериев данных.

**Критерии (минимальный набор):**

- глубина истории > 12 месяцев,
- доля активных месяцев,
- качество модели (MAPE).

**Выдача прогнозов:**

- A/B: отдаём прогноз (MVP или бейзлайн — что лучше по backtesting),
- C: прогноз в прод не отдаём; в пилоте можем продолжать считать для контроля и сравнения с ручными прогнозами.

**Объяснение причин отбраковки (пример):**

- “история < 12 месяцев”,
- “высокая доля нулевых месяцев → нестабильность”,
- “MAPE > 15% на backtesting”,
- “слишком широкий CI”.

---

### Этап 7 — Инференс и обновления

- пересчёт раз в месяц (Airflow),
- скоринг на 1–3 месяца,
- запись в витрину прогнозов,
- отдача через API/UI.

---

### Этап 8 — Итоговый отчёт по итерации

- сравнение с бейзлайном,
- сравнение с ручными прогнозами,
- доля A/B/C и динамика,
- рекомендации по улучшениям (включая кандидатов на кластеризацию и отдельные модели).

---

# 3. Подготовка пилота

## 3.1. Дизайн пилота

Пилот проводится в “параллельном” режиме: система строит прогнозы, менеджеры продолжают вводить ручной прогноз. Результаты используются в планировании, но решение о доверии к прогнозу принимается постепенно на горизонте нескольких месяцев.

## 3.2. Что считаем успешным пилотом

- Значимая доля филиалов в A/B по итогам backtesting (ориентир: MAPE ≤ 15% для большинства допущенных филиалов).
- MVP не хуже бейзлайна в среднем, а в ряде филиалов лучше.
- Управляемая доля C-филиалов с понятными причинами.
- Финдиректор подтверждает применимость прогнозов в регулярном планировании.

## 3.3. Ограничения по вычислениям

- обучение: минуты,
- скоринг: секунды,
- обновление: один раз в месяц,
- GPU не требуется.

---

# 4. Внедрение для production

## 4.1. Архитектура решения

Airflow → Postgres → Feature Prep → MLflow → Scoring → FastAPI → UI  
(Диаграмма находится в `docs/ts_forecast_architecture.svg`)

## 4.2. Инфраструктура и масштабируемость

**Выбрано:** on-prem Airflow + Postgres + MLflow + FastAPI.  
**Причины:** безопасность, стоимость, простота эксплуатации.  
**Альтернативы:** Kubeflow (избыточно), Spark (не нужен).

## 4.3. Требования к системе (SLA)

- Обновление прогноза: раз в месяц до 10:00.
- API latency < 300 мс.
- Доступность ≥ 99%.

## 4.4. Безопасность системы

- доступ по VPN,
- логирование всех операций,
- ролевой доступ.

## 4.5. Безопасность данных

- Персональных данных нет.
- GDPR не применим.
- Данные не покидают периметр.

## 4.6. Издержки

- Compute: < 2 CPU·ч / месяц.
- Storage: < 1 ГБ.
- Поддержка: 2–4 ч / месяц.

## 4.7. Integration points

API FastAPI:

- `GET /forecast/{branch_id}`
- `GET /forecast/network_summary`
- `GET /branches/status`
- `GET /metrics/model_quality`

## 4.8. Риски внедрения

- низкое качество данных отдельных филиалов,
- задержки выгрузки,
- непринятие модели пользователями,
- структурные изменения филиалов.

---

# Конец документа
